---
title: 【Rails初学者】マイグレーションの基礎についてざっくり理解する
tags:
  - Rails
  - マイグレーション
  - 初学者
private: false
updated_at: '2025-12-12T06:49:21+09:00'
id: f5131e80b2ade10b38c8
organization_url_name: null
slide: false
ignorePublish: false
---
# はじめに
Railsのマイグレーションについて、なんとなく使っていたものの根本的な理解の部分が足りていないと感じていたので、改めて基礎から理解を深めていきたいと思います💪
同じような方や初学者の方の参考になれば嬉しいです！

![migration.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/3117662/fd29d12f-f1ef-498d-8e64-8539a889d625.png)

# マイグレーションとは
マイグレーション（migration）とは日本語で「移行」や「移動」を意味し、Railsにおいては**データベースのスキーマ（構造）を管理・変更するための仕組み**を指します。
プログラムのコード変更を管理するために「Git」を使いますが、マイグレーションは**データベースの構造変更をバージョン管理するためのツール**と考えるとイメージしやすいかと思います！

# データベースが作成される仕組み
マイグレーションの理解を深めるために、Railsアプリケーションでデータベースがどのように作成されるかを確認していきます🙌

簡単なイメージ図を作成してみたので、こちらもあわせて参考にしてください！！

![migration-flow.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/3117662/d2dd303c-3b90-4c49-b14a-72690898fcf3.png)

## 1.接続先の設定
Railsがデータベースという違う世界とやりとりするためには、まず「どのRDBMS（MySQLやPostgreSQLなど）を使うのか？」「ユーザー名やパスワードは何か？」を知る必要があります。
その情報をRailsに教えてあげるのが`config/database.yml`ファイルになります！

参考: [Railsガイド - データベースの設定](https://railsguides.jp/v8.1/configuring.html#%E3%83%87%E3%83%BC%E3%82%BF%E3%83%99%E3%83%BC%E3%82%B9%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B)

## 2. データベースの作成
設定ファイル`config/database.yml`をもとに、データベースの「箱（入れ物）」だけを作成します。
このときに使うコマンドが以下になります。
```bash
rails db:create
```
このコマンドを実行すると、`database.yml`に記載されている情報をもとに、指定されたRDBMS上にデータベースが作成されます。ちなみに、この段階ではまだ`users`テーブルや`articles`テーブルなどは存在せず、空っぽのデータベースが作成されるだけです。

開発において最初のみしか実行しないコマンドなので、あまり馴染みがないかもしれません😂

## 3. 設計図の作成（マイグレーションファイル）
ここから開発で必要となる具体的なテーブルの構造を定義します。
例えば、`users`テーブルを作成したい場合は、以下のコマンドを実行しマイグレーションファイルを作成します。
```bash
rails generate migration CreateUsers
```

このコマンドを実行すると、`db/migrate`ディレクトリにタイムスタンプ付きのマイグレーションファイル（`20251203123456_create_users.rb`のようなファイル名）が作成されます。

このファイルの中に、`users`テーブルのカラムやデータ型などの情報を記述していきます✍️
```ruby
class CreateUsers < ActiveRecord::Migration[8.0]
  def change
    create_table :users do |t|
      t.string :name
      t.string :email
      t.timestamps
    end
  end
end
```

マイグレーションファイルの具体的な書き方については、Railsガイドに詳しく記載されているので、そちらを参考にしてください😊


https://railsguides.jp/active_record_migrations.html#%E3%83%9E%E3%82%A4%E3%82%B0%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E7%94%9F%E6%88%90%E3%81%99%E3%82%8B

## 4. テーブルの構築
最後に、作成した設計図（マイグレーションファイル）をデータベースに適用します！
```bash
rails db:migrate
```

このコマンドを実行すると、
1. Railsが`db/migrate`ディレクトリ内のマイグレーションファイルを順番に読み込み、定義された内容に基づいてSQL（`CREATE TABLE ...`など）に翻訳してデータベースにテーブルやカラムを作成・変更します。
2. `db/schema.rb`ファイルが更新され、現在のデータベースのスキーマ情報が反映されます。

:::note info
`db/schema.rb`ファイルとは？
- データベースの現在の構造を一目で確認できる「スナップショット」ファイル
- マイグレーションファイルが「**変更履歴**」だとすると、`schema.rb`は「**最新の完成図**」
- マイグレーションを実行するたびに自動的に更新され、データベースの構造がどのようになっているのか一目で確認できるため便利⭐️

:::

# マイグレーションの仕組み
## タイムスタンプ
マイグレーションファイルを作成すると、ファイル名の先頭にタイムスタンプが自動的に付与されます。
タイムスタンプとは下記例の`20251120164103`部分
（例：`db/migrate/20251120164103_create_comments.rb`）

これは「いつ作られたか」を表す日時（UTC）であり、**マイグレーションID**として扱われます。 Railsはこの数字が小さい（古い）順にファイルを読み込むことで、データベースの変更の順番を保証しています。

## schema_migrationsテーブル
マイグレーションの仕組みを理解するには、**`schema_migrations`テーブル**の存在を知る必要があります！
このテーブルは`db/schema.rb`には記載されていませんが、Railsがマイグレーションの状態を管理するために内部的に使用している特別なテーブルです。

（↓実際の`schema_migrations`テーブルの中身の例）

![スクリーンショット 2025-12-12 0.10.25.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/3117662/6c7c1f07-d18e-4eba-8091-d8f344ab7591.png)

## rails db:migrate実行時の流れ
1. Railsはまず`schema_migrations`テーブルを確認し、すでに適用されたマイグレーションファイルのID（タイムスタンプ）を取得
2. `db/migrate`ディレクトリ内のマイグレーションファイルをタイムスタンプ順にチェックし、`schema_migrations`テーブルに存在しないIDのファイルだけを実行<br>逆にいうと、**すでに`schema_migrations`テーブルに存在するIDのファイルはスキップされる**
3. 実行が成功したら、そのマイグレーションIDを`schema_migrations`テーブルに追加し、次回以降の実行時に再度適用されないようにする
4. 実行後のデータベースの状態を`db/schema.rb`に反映する

::: note info
Q. `rails db:schema:load`コマンドとは？

- `db/schema.rb`ファイルの内容を直接データベースに反映するコマンドです！
- 使用タイミングとしては、プロジェクトの開発環境のセットアップや、データベースを初期化したいとき、テスト環境の準備などに利用されます。

**rails db:migrateとの違い**
| |rails db:migrate |	rails db:schema:load |
|--|------------------|-----------------------|
| 実行内容|	マイグレーションファイルを1つずつ順番に実行	|schema.rbを一気に読み込んで反映
|速度	|遅い（特にマイグレーションが多い場合）|	速い
|用途	|開発中の通常のマイグレーション実行	|新規環境のセットアップ|

**注意点**
- このコマンドは、仕様として「**既存のデータが入っていても、一旦テーブルを空にして作り直す（リセットする）**」という挙動をするため、データが入っている状態で使用するとそのデータが消えてしまいます。
- そのため、通常の開発中にはあまり使わず、新規セットアップやテスト環境での利用に限定するのが一般的です。（もちろん本番環境ではもってのほかです）

:::

# 参考記事

https://railsguides.jp/active_record_migrations.html

https://qiita.com/Arashi-K/items/4e26fd367847b8bbed18

https://qiita.com/hirohero/items/2f29334878b0cb525bda
